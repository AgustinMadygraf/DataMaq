<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<title>Visión por Computadora</title>
	<link href="../assets/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="../assets/css/app.css">
	<link rel="shortcut icon" href="../assets/img/favicon.ico" type="image/x-icon">
	<script src="../assets/js/bootstrap.bundle.min.js"></script>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

</head>
<body>
	<div id="header-container"></div>
	<div class="container mt-5 pt-5">
		<h2 class="mb-4">Visión por Computadora</h2>
		<div id="resolution-info" class="mb-3"></div>
		<div class="stream-container">
			<h5>Stream en Vivo</h5>
			<img id="stream-img" src="http://127.0.0.1:5000/stream.mjpg" alt="Stream MJPEG" style="max-width:100%; border:1px solid #333;">
			<div id="stream-error" class="error-message" style="display:none;">No se puede mostrar el stream.</div>
		</div>
		<div class="snapshot-container">
			<h5>Snapshot</h5>
			<button id="snapshot-btn" class="btn btn-primary">Tomar Snapshot</button>
			<div id="snapshot-loading" style="display:none;" class="mt-2">
				<div class="spinner-border text-primary" role="status"></div>
				<span class="ms-2">Cargando...</span>
			</div>
			<img id="snapshot-img" class="snapshot-img" src="" alt="Snapshot" style="display:none;">
			<div id="snapshot-info" class="mt-2"></div>
			<div id="snapshot-error" class="error-message" style="display:none;"></div>
		</div>
	</div>
	<script src="../assets/js/bootstrap.bundle.min.js"></script>
	<script>
	// Cargar el header dinámicamente con manejo de error/fallback
	fetch('../templates/header.html')
		.then(response => {
			if (!response.ok) throw new Error('No se pudo cargar el header');
			return response.text();
		})
		.then(html => {
			const headerContainer = document.getElementById('header-container');
			if (headerContainer) {
				headerContainer.innerHTML = html;
			}
		})
		.catch(err => {
			const headerContainer = document.getElementById('header-container');
			if (headerContainer) {
				headerContainer.innerHTML = `<div class="alert alert-warning" role="alert">No se pudo cargar el menú de navegación.</div>`;
			}
			console.error('Error al cargar el header:', err);
		});

	// Mostrar resolución
	function fetchResolution() {
		fetch('http://127.0.0.1:5000/resolution')
			.then(res => res.ok ? res.json() : null)
			.then(data => {
				if (data && data.width && data.height) {
					document.getElementById('resolution-info').textContent = `Resolución: ${data.width} x ${data.height}`;
				} else {
					document.getElementById('resolution-info').textContent = '';
				}
			})
			.catch(() => {
				document.getElementById('resolution-info').textContent = '';
			});
	}
	fetchResolution();

	// Tomar snapshot
	document.getElementById('snapshot-btn').addEventListener('click', function() {
		const loading = document.getElementById('snapshot-loading');
		const img = document.getElementById('snapshot-img');
		const info = document.getElementById('snapshot-info');
		const error = document.getElementById('snapshot-error');
		loading.style.display = 'inline-block';
		img.style.display = 'none';
		info.textContent = '';
		error.style.display = 'none';
		fetch('http://127.0.0.1:5000/snapshot.jpg')
			.then(res => {
				if (!res.ok) throw new Error('No se pudo obtener el snapshot');
				return res.blob();
			})
			.then(blob => {
				const url = URL.createObjectURL(blob);
				img.src = url;
				img.style.display = 'block';
				info.textContent = `Snapshot tomado: ${new Date().toLocaleString()}`;
			})
			.catch(() => {
				error.textContent = 'Error al tomar el snapshot. La cámara puede no estar disponible.';
				error.style.display = 'block';
			})
			.finally(() => {
				loading.style.display = 'none';
			});
	});

	// Detectar error en el stream (si la imagen no carga)
	document.getElementById('stream-img').addEventListener('error', function() {
		document.getElementById('stream-error').style.display = 'block';
	});
	document.getElementById('stream-img').addEventListener('load', function() {
		document.getElementById('stream-error').style.display = 'none';
	});
	</script>
</body>
</html>
