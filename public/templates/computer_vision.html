<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Visión por Computadora</title>
    <link href="../assets/css/bootstrap.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="../assets/img/favicon.ico" type="image/x-icon">
    <script src="../../src/infrastructure/bootstrap.bundle.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="header-container"></div>
    <div class="container-fluid d-flex flex-column justify-content-center align-items-center" style="min-height:100vh;">
        <div id="resolution-info" class="mb-3"></div>
        <div class="row w-100">
            <div class="stream-container col-12 mb-4 d-flex flex-column align-items-center">
                <img
                    id="stream-img"
                    src="http://127.0.0.1:5000/stream.mjpg"
                    alt="Stream MJPEG"
                    class="img-fluid"
                    style="border:1px solid #333; max-height: 80vh; object-fit: contain;"
                />
                <div id="stream-status" class="mt-2"></div>
            </div>
        </div>
        
        <!-- Controles de cámara -->
        <div class="row w-100 justify-content-center mb-3">
            <div class="col-md-6 text-center">
                <!-- Botón de snapshot eliminado -->
            </div>
        </div>
        
        <!-- Área para mostrar el snapshot eliminada -->
    </div>
    
    <script src="../../src/infrastructure/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { loadHeader } from '../../src/adapters/headerLoader.js';
        import { StreamWebSocketHandler } from '../../src/interface_adapters/gateways/streamWebSocket.js';

        // Detectar IP/host dinámicamente
        const host = window.location.hostname;
        const port = 5000; // Cambia si usas otro puerto

        // Actualizar el src del stream
        document.getElementById('stream-img').src = `http://${host}:${port}/stream.mjpg`;

        // Inicializar WebSocket con IP dinámica
        class CustomWebSocketHandler extends StreamWebSocketHandler {
            connect() {
                try {
                    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsUrl = `${protocol}//${host}:${port}/ws`;
                    this.ws = new WebSocket(wsUrl);
                    // ...resto igual...
                } catch (error) {
                    console.error('Error al conectar WebSocket:', error);
                }
            }
        }
        const wsHandler = new CustomWebSocketHandler();
        wsHandler.connect();

        // Obtener información de resolución con IP dinámica
        async function getResolution() {
            try {
                const response = await fetch(`http://${host}:${port}/resolution`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('resolution-info').textContent =
                        `Resolución: ${data.width} x ${data.height}`;
                }
            } catch (error) {
                console.error('Error al obtener resolución:', error);
            }
        }

        getResolution();

        window.addEventListener('beforeunload', () => {
            wsHandler.disconnect();
        });
    </script>
    <style>
        @media (min-width: 992px) {
            #stream-img {
                max-height: 80vh !important;
            }
        }
        
        .stream-lost {
            opacity: 0.5;
            filter: grayscale(100%);
        }
    </style>
</body>
</html>
